from django.shortcuts import render
from django.forms import *

from rest_framework.response import Response
from rest_framework import generics, viewsets
from rest_framework.views import *
from rest_framework.decorators import action
from rest_framework.permissions import *
from rest_framework.pagination import PageNumberPagination

from .recommendations import recommendation
import pandas as pd

from .serializers import *
from .models import *

# Create your views here.


class TovarListPagination(PageNumberPagination):
    page_size = 15


# –ó–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–∏–∂–µüîΩ (get, post, put, delete)
class BookViewSet(viewsets.ModelViewSet):
    queryset = Book.objects.all()
    serializer_class = BookSerializer
    permission_classes = (IsAuthenticatedOrReadOnly,)  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

    # –ï—Å–ª–∏ —Ö–æ—Ç–∏–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–¥–∞—á—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (queryset ‚¨ÜÔ∏è —É–∂–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
    def get_queryset(self):
        pk = self.kwargs.get('pk')

        if not pk:
            return Book.objects.all()[:3]

        # –ù–µ get(), –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫
        return Book.objects.filter(pk=pk)

    # –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ url( ..api/v1/book/<pk>/author/ )

    @action(methods=["get"], detail=True)
    def author(self, request, pk=None):
        cats = Author.objects.get(pk=pk)
        return Response({"cats": cats.name})


# class TovarViewSet(viewsets.ModelViewSet):
#     queryset = Tovars.objects.all()
#     serializer_class = TovarSerializer
#     pagination_class = TovarListPagination     # –ü–∞–≥–∏–Ω–∞—Ü–∏—è


class TovarApiView(APIView):
    def get(self, request):
        return Response({"Error": "Only POST"})

    def post(self, request):
        iddoc = request.data['iddoc']
        checks = Tovars.objects.filter(iddoc=iddoc)

        checks_dict = []

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –≤ —Å–ª–æ–≤–∞—Ä—å
        for check in checks:
            checks_dict.append({
                "iddoc": check.iddoc,
                "kolvo": check.kolvo,
                "summa": check.summa
            })

        checks = pd.DataFrame(checks_dict) 

        group_by_iddoc = checks.groupby(['iddoc'])
        check = group_by_iddoc.sum() 
        check['count_uniq_good'] = group_by_iddoc.size()
        check.index.name = None


        # –°–æ–∑–¥–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (return: dict)   max: 25
        recommended = []
        tryes = 0

        while not recommended:
            recommending = recommendation.Recommendation()
            recommended = recommending.get_recommendations(check)
            tryes += 1
            print(f"Try {tryes}")
        
        for tovar in recommended:
            tovar["name"] = tovar["name"].replace("  ", '')

        return Response({"recommendations": recommended})











    #
    #
    #
    #
    # --------------------------------------------------------------------------------
    # class BookApiList(generics.ListCreateAPIView):
    #     queryset = Book.objects.all()
    #     serializer_class = BookSerializer
    # class BookApiUpdate(generics.UpdateAPIView):
    #     queryset = Book.objects.all()    # –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤—ã–±–µ—Ä–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —ç–ª.
    #     serializer_class = BookSerializer
    # --------------------------------------------------------------------------------
    # class BookApiView(APIView):
    #     def get(self, request):
    #         lst = Book.objects.all()
    #         return Response({"posts": BookSerializer(lst, many=True).data})
    #     def post(self, request):
    #         serializer = BookSerializer(data=request.data)
    #         serializer.is_valid(raise_exception=True)
    #         serializer.save()
    #         return Response({"post": serializer.data})
    #     def put(self, request, *args, **kwargs):
    #         pk = kwargs.get('pk', None)
    #         if not pk:
    #             return Response({"error": "Method PUT is not allowed"})
    #         try:
    #             instance = Book.objects.get(pk=pk)
    #         except:
    #             return Response({"error": "Object does not exists"})
    #         serializer = BookSerializer(data=request.data, instance=instance)
    #         serializer.is_valid(raise_exception=True)
    #         serializer.save()
    #         return Response({"post": serializer.data})
    #     def delete(self, request, *args, **kwargs):
    #         pk = kwargs.get("pk", None)
    #         if not pk:
    #             return Response({"error": "Methon DELETE is not allowed"})
    #         try:
    #             Book.objects.get(pk=pk).delete()
    #         except:
    #             return Response({"error": "Incorrect ID of post"})
    #         return Response({"post": f"Post id={pk} has been deleted"})
